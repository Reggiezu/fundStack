<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Dashboard - FundStack</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version) -->
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <!-- Google fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i"
      rel="stylesheet"
    />
    <!-- Core theme CSS (includes Bootstrap) -->
    <link href="styles.css" rel="stylesheet" />
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
  </head>
  <body id="page-top">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
      <div class="container px-5">
        <a class="navbar-brand" href="index.html">FundStack</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarResponsive"
          aria-controls="navbarResponsive"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="about.html">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="signup.html" id="signUpBtn">Sign Up</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="signin.html" id="logInBtn">Log In</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="contact.html">Contact Us</a>
            </li>
            <li class="nav-item dropdown" id="profileBtn" style="display: none">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="profileDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Profile
              </a>
              <ul class="dropdown-menu" aria-labelledby="profileDropdown">
                <li><p id="profilePic">X.X</p></li>
                <li>
                  <a class="dropdown-item" href="profile.html">Settings</a>
                </li>
                <li>
                  <a class="dropdown-item" id="signOutBtn" href="#">Sign Out</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
      <h2 class="mb-4">User Transactions <button type="submit" class="btn btn-primary btn-l rounded-pill mt-3" id="newTrans">
        Add new +
      </button></h2>
      <div id="myPopup" class="popup" >
        <!-- style="display: none" -->
        <form>
          <label for="date">Date:</label><br>
          <input type="date" id="date" name="date"><br><br>
          <label for="description">Description:</label><br>
          <input type="text" id="description" name="description"><br><br>
          <label for="category">Category:</label><br>
          <input type="text" id="category" name="category"><br><br>
          <label for="amount">Amount:</label><br>
          <input type="number" id="amount" name="amount"><br><br>
          <button type="button" id="closePopup">Close</button>
          <button type="submit" id="submitPopup">Submit</button>
        </form>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">Date</th>
              <th scope="col">Description</th>
              <th scope="col">Category</th>
              <th scope="col">Amount</th>
            </tr>
          </thead>
          <tbody id="transactionsTableBody">
            <!-- Transaction rows will be added here dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer-->
    <footer class="py-5 bg-black">
      <div class="container px-5">
        <p class="m-0 text-center text-white small">
          Copyright &copy; FundStack 2024
        </p>
      </div>
    </footer>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS and main logic -->
    <script src="auth.js"></script>
    <script src="main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
            const db = firebase.firestore();
    
            // Popup and transaction form logic
            const transBtn = document.getElementById("newTrans");
            const popup = document.getElementById("myPopup");
            const closeButton = document.getElementById("closePopup");
            const submitButton = document.getElementById("submitPopup");
    
            // Show the popup form
            transBtn.onclick = function () {
              popup.style.display = "block";
            };
    
            // Close the popup form
            closeButton.onclick = function () {
              popup.style.display = "none";
            };
    
            // Close the popup form if clicking outside the popup
            window.onclick = function (event) {
              if (event.target == popup) {
                popup.style.display = "none";
              }
            };
    
            // Submit the form and add transaction to Firestore
            submitButton.onclick = function (e) {
              e.preventDefault(); // Prevent page refresh
    
              // Get input values from the form
              const dateValue = document.getElementById("date").value;
              const descriptionValue = document.getElementById("description").value;
              const categoryValue = document.getElementById("category").value;
              const amountValue = parseFloat(document.getElementById("amount").value);
    
              // Add the transaction to Firestore
              db.collection("transactions")
                .add({
                  userId: user.uid,
                  date: dateValue,
                  description: descriptionValue,
                  category: categoryValue,
                  amount: amountValue,
                })
                .then(() => {
                  alert("Transaction added successfully.");
                  popup.style.display = "none"; // Close the popup after saving
                })
                .catch((error) => {
                  console.error("Error adding transaction: ", error);
                });
            };
    
            // Reference to transactions collection for the current user
            const transactionsRef = db
              .collection("transactions")
              .where("userId", "==", user.uid);
    
            // Real-time listener for fetching transactions
            transactionsRef.onSnapshot((querySnapshot) => {
              const transactionsTableBody = document.getElementById("transactionsTableBody");
              transactionsTableBody.innerHTML = ""; // Clear existing rows
              querySnapshot.forEach((doc) => {
                const transaction = doc.data();
                const row = document.createElement("tr");
    
                row.innerHTML = `
                      <td>${transaction.date}</td>
                      <td>${transaction.description}</td>
                      <td>${transaction.category}</td>
                      <td>${transaction.amount}</td>
                  `;
                transactionsTableBody.appendChild(row);
              });
            }, (error) => {
              console.error("Error fetching transactions: ", error);
            });
    
          } else {
            console.log("No user is signed in, redirecting to login page.");
            window.location.href = "signin.html";
          }
        });
      });
    </script>      
  </body>
</html>
