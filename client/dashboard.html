<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Dashboard - FundStack</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version) -->
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <!-- Google fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i"
      rel="stylesheet"
    />
    <!-- Core theme CSS (includes Bootstrap) -->
    <link href="styles.css" rel="stylesheet" />
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
  </head>
  <body id="page-top" style="padding-top: 70px;">
    <!-- Navigation -->
    <div id="navbar"></div>
    <!-- Main Content -->
    <div class="container-fluid mt-4">
      <div class="row">
        <!-- Welcome Section -->
        <div class="col-lg-9 mb-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h3 class="card-title" id="welcome">Hi, welcome back!</h3>
              <p>Your web analytics dashboard template.</p>
              <div class="d-flex">
                <button class="btn btn-secondary me-3">
                  <i class="fas fa-envelope"></i> Email
                </button>
                <button class="btn btn-secondary me-3"
                data-bs-toggle="modal"
                data-bs-target="#balanceModal">
                  <i class="fa-solid fa-money-bill-1-wave" id="userBalance"></i> Assign Balance
                </button>
                <button class="btn btn-primary"
                data-bs-toggle="modal"
                  data-bs-target="#accountModal">
                  <i class="fas fa-user-plus" id="userAccount"></i> Add Account
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Info Cards -->
        <div class="col-lg-3 mb-4">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title">Balance</h5>
              <h6 class="card-subtitle mb-2 text-muted" id="userBalanceInfoCard">$</h6>
            </div>
          </div>
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title">Total Expenses</h5>
              <h6 class="card-subtitle mb-2 text-muted">$4,567</h6>
            </div>
          </div>
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title">Savings</h5>
              <h6 class="card-subtitle mb-2 text-muted">$3,000</h6>
            </div>
          </div>
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Budget</h5>
              <h6 class="card-subtitle mb-2 text-muted">$5,000</h6>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Purchase History Card -->
        <div class="col-lg-8 mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title">Purchase History</h5>
                <button
                  type="button"
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#transactionModal"
                >
                  Add New Transaction
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th scope="col">Date</th>
                      <th scope="col">Description</th>
                      <th scope="col">Category</th>
                      <th scope="col">Amount</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                    <!-- Transaction rows will be added here dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Category Card -->
        <div class="col-lg-4 mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title">Category Overview</h5>
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-toggle="modal"
                  data-bs-target="#categoryModal"
                >
                  Add New Category +
                </button>
              </div>
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Goals Card -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Goals</h5>
              <ul class="list-group">
                <li class="list-group-item">
                  <input class="form-check-input me-1" type="checkbox" value="" />
                  Complete category report
                </li>
                <li class="list-group-item">
                  <input class="form-check-input me-1" type="checkbox" value="" />
                  Review transaction history
                </li>
                <li class="list-group-item">
                  <input class="form-check-input me-1" type="checkbox" value="" />
                  Update savings plan
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Calendar Card -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Calendar</h5>
              <div id="calendar"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
     <!-- Balance Modal -->
    <div
    class="modal fade"
    id="balanceModal"
    tabindex="-1"
    aria-labelledby="balanceModalLabel"
    aria-hidden="true"
  >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="balanceModalLabel">Assign Balance</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="balanceForm">
          <div class="mb-3">
           <h6>Current balance: </h6> <h6 id="userBalanceModal">$</h6>
          </div>
          <p>Category</p>
          <div class="mb-3">
              <select class="form-select" aria-label="Default select example" id="categoryDropdownBM" name="category" required>
              <option value="" disabled selected>Select Category</option>
            </select>                
            </div>
            <div class="mb-3">
              <label for="balanceAmount" class="form-label">Amount</label>
              <input
                type="number"
                class="form-control"
                id="balanceAmount"
                required
              />
            </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>
      <!-- Account Modal -->
    <div
    class="modal fade"
    id="accountModal"
    tabindex="-1"
    aria-labelledby="accountModalLabel"
    aria-hidden="true"
  >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="accountModalLabel">Add New Account</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="accountForm">
          <div class="mb-3">
            <label for="accountName" class="form-label">Account Name</label>
            <input
              type="text"
              class="form-control"
              id="accountName"
              required
            />
          </div>
          <div class="mb-3">
            <p>Account Type:</p>
            <div class="form-check">    
              <input class="form-check-input" type="radio" name="accountType" id="checkingRadioA" value="checking">
              <label class="form-check-label" for="flexRadioDefault1">
                Checking
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="accountType" id="savingRadioA" checked value="saving">
              <label class="form-check-label" for="flexRadioDefault2">
                Saving
              </label>
            </div>              
          </div>
          <div class="mb-3">
            <label for="accountBalance" class="form-label">Balance</label>
            <input
              type="number"
              class="form-control"
              id="accountBalance"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  </div>
  </div>
    <!-- Transaction Modal -->
    <div
      class="modal fade"
      id="transactionModal"
      tabindex="-1"
      aria-labelledby="transactionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="transactionModalLabel">Add New Transaction</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="transactionForm">
              <div class="mb-3">
                <label for="transactionDate" class="form-label">Date</label>
                <input type="date" class="form-control" id="transactionDate" required />
              </div>
              <div class="mb-3">
                <label for="transactionDescription" class="form-label">Description</label>
                <input
                  type="text"
                  class="form-control"
                  id="transactionDescription"
                  required
                />
              </div>
                <p>Category</p>
              <div class="mb-3">
                  <select class="form-select" aria-label="Default select example" id="categoryDropdown" name="category" required>
                  <option value="" disabled selected>Select Category</option>
                  <!-- Category options will be dynamically populated here -->
                </select>                
                </div>
                <p>Account:</p>
                <div class="mb-3">
                  <select class="form-select" aria-label="Default select example" id="accountDropdown" name="account" required>
                 <option value="" disabled selected>Select Account</option>
                  <!-- Account options will be dynamically populated here -->
                </select>                
              </div>
              <div class="mb-3">
                <label for="transactionAmount" class="form-label">Amount</label>
                <input
                  type="number"
                  class="form-control"
                  id="transactionAmount"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Modal -->
    <div
      class="modal fade"
      id="categoryModal"
      tabindex="-1"
      aria-labelledby="categoryModalLabel"
      aria-hidden="true"
    >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalLabel">Add New Category</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form id="categoryForm">
            <div class="mb-3">
              <label for="categoryName" class="form-label">Category Name</label>
              <input
                type="text"
                class="form-control"
                id="categoryName"
                required
              />
            </div>
            <div class="mb-3">
              <p>Category Type:</p>
              <div class="form-check">    
                <input class="form-check-input" type="radio" name="categoryType" id="expenseRadioC" value="expense">
                <label class="form-check-label" for="flexRadioDefault1">
                  Expense
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="categoryType" id="savingRadioC" checked value="saving">
                <label class="form-check-label" for="flexRadioDefault2">
                  Saving
                </label>
              </div>              
            </div>
            <div class="mb-3">
              <label for="categoryAmount" class="form-label">Amount</label>
              <input
                type="number"
                class="form-control"
                id="categoryAmount"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
        </div>
      </div>
    </div>
    </div>
   
    <!-- Delete Confirmation Modal -->
<div id="deleteTransactionModal" class="modal fade" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="deleteModalLabel">Delete Transaction</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <p>You are about to delete this transaction, and this action cannot be undone.</p>
              <p>Are you sure you want to proceed?</p>
              <p id="debug-url"></p>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="keepData">No, Keep It</button>
              <button type="button" class="btn btn-danger" id="confirmDeleteTransaction">Yes, Delete It</button>
          </div>
      </div>
  </div>
</div>
<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>


  </div>
  
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS and main logic -->
    <script src="auth.js"></script>
    <script src="main.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

    <script> 
      document.addEventListener("DOMContentLoaded", function () {
          firebase.auth().onAuthStateChanged(function (user) {
              if (user) {
                  const db = firebase.firestore();
                  const userId = user.uid;
                  const userFLname = user.displayName;
                  const welcomeName = document.getElementById("welcome");
                  welcomeName.innerHTML = `Hi, Welcome Back ${userFLname}!`;
                  const balanceIdIC = document.getElementById("userBalanceInfoCard");
                  const balanceModal = document.getElementById('userBalanceModal');
                  let initialBalance ;
                  fetchFirestoreData(userId);
                  let currentTransactionId = null; // To keep track of the transaction being edited
                  const amountInput = document.getElementById("balanceAmount");
                  // Create a new Bootstrap toast instance
                  function toast({ title, description }) {
                    // Create the toast element
                  const toastElement = document.createElement('div');
                  toastElement.className = 'toast';
                  toastElement.role = 'alert';
                  toastElement.setAttribute('aria-live', 'assertive');
                  toastElement.setAttribute('aria-atomic', 'true');

                  // Construct the toast HTML
                  toastElement.innerHTML = `
                      <div class="toast-header">
                          <strong class="me-auto">${title}</strong>
                          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                      </div>
                      <div class="toast-body">
                          ${description}
                      </div>
                  `;

                  // Append to the toast container
                  document.getElementById('toastContainer').appendChild(toastElement);

                  // Create and show the toast using Bootstrap's Toast class
                  const bootstrapToast = new bootstrap.Toast(toastElement);
                  bootstrapToast.show();
                  
                  // Optionally, remove the toast element after it hides to keep DOM clean
                  toastElement.addEventListener('hidden.bs.toast', () => {
                      toastElement.remove();
                  });
              }

                  //fetch Info Card data 
                  // Fetch User Info and Update Balance
                    async function fetchFirestoreData(userId) {
                        try {
                            const userDoc = await db.collection("users").doc(userId).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                const balance = userData.balance || 0; // Use 0 as default if balance is null or undefined
                                initialBalance = userData.balance || 0; 
                                // Set the balance
                                balanceIdIC.innerHTML = `$${balance}`;
                                balanceModal.innerHTML = `$${initialBalance}`;
                            // Only add the event listener after `initialBalance` is set
                              if (amountInput) {
                                console.log("Adding event listener to amount input field");

                                  amountInput.addEventListener("input", updateValue);
                              } else {
                                  console.error("Amount input element not found");
                              }
                          } else {
                              console.error("User document not found");
                          }
                        } catch (error) {
                            console.error("Error fetching user document:", error);
                        }
                    }
                    function updateValue() {
                    console.log("Update value triggered");
                    console.log("Initial Balance:", initialBalance);
                    if (initialBalance !== undefined) {
                        const amount = parseFloat(amountInput.value) || 0; // Get the amount user has input
                        const updatedBalance = initialBalance - amount; // Calculate the updated balance
                        if (updatedBalance<0){
                          toast({
                          title: "Insufficient Balance",
                          description: "Please ensure your balance is sufficient to assign this amount.",
                      });
                        }else {
                        console.log("Updated Balance:", updatedBalance);
                        balanceModal.innerHTML = `$${updatedBalance}`; // Update the balance display
                        }
                    } else {
                        console.error("Initial balance is not defined yet");
                    }
                }

                  // Transaction Form Logic
                  const transactionForm = document.getElementById("transactionForm");
                  const balanceForm = document.getElementById("balanceForm")
                  if (transactionForm) {
                      console.log("Transaction form found:", transactionForm);
                      transactionForm.addEventListener("submit", function (event) {
                          event.preventDefault();
                          handleTransaction();
                      });
                  }
                  //Transaction Form Accounts and Categories
                  db.collection("accounts")
                      .where("userId", "==", userId)
                      .get()
                      .then((querySnapshot) => {
                        const accountDropdown = document.getElementById("accountDropdown")
                              if (querySnapshot.empty) {
                                  console.log("No accounts found for the user.");
                                  accountDropdown.innerHTML = "No accounts found";
                              } else {
                                  querySnapshot.forEach((doc) => {
                                      const account = doc.data();
                                      const options = document.createElement("option");
                                      if (account) {
                                          options.innerHTML = `
                                              ${account.accountName || 'N/A'}
                                          `;
                                          accountDropdown.appendChild(options);
                                      }
                                      
                                  });
                                }
                          })
                          db.collection("categories")
                      .where("userId", "==", userId)
                      .get()
                      .then((querySnapshot) => {
                        const categoryDropdown = document.getElementById("categoryDropdown")
                              if (querySnapshot.empty) {
                                  console.log("No categories found for the user.");
                                  categoryDropdown.innerHTML = "No categories found";
                              } else {
                                  querySnapshot.forEach((doc) => {
                                      const category = doc.data();
                                      const options = document.createElement("option");
                                      if (category) {
                                          options.innerHTML = `
                                              ${category.name || 'N/A'}
                                          `;
                                          categoryDropdown.appendChild(options);
                                      }
                                  });
                                }
                          })
                          
                          // Balance form logic
                          if (balanceForm) {
                              console.log("Balance form found:", balanceForm);
                              balanceForm.addEventListener("submit", function (event) {
                                  event.preventDefault(); // Prevent default form submission

                                  console.log("Balance form submitted, starting fetch...");

                                  // Fetch user data first
                                  fetchFirestoreData(userId)
                                      .then(() => {
                                          // Get form values
                                          const category = document.getElementById("categoryDropdownBM").value;
                                          const amount = parseFloat(document.getElementById("balanceAmount").value);

                                          console.log("Fetched initial balance:", initialBalance);
                                          console.log("Amount to allocate:", amount);

                                          // Validate balance before proceeding
                                          if (initialBalance === undefined) {
                                              console.error("Initial balance is not defined.");
                                              return;
                                          }

                                          if (amount > initialBalance) {
                                              toast({
                                                  title: "Insufficient Balance",
                                                  description: "Please ensure your balance is sufficient to assign this amount.",
                                              });
                                              return; // Stop here if balance is insufficient
                                          }

                if (category && amount) {
                    console.log("Category and amount are valid, updating Firestore...");
                    
                    // Update category and balance in Firestore
                    db.collection("categories")
                        .where("userId", "==", userId)
                        .where("name", "==", category)
                        .get()
                        .then((querySnapshot) => {
                            if (!querySnapshot.empty) {
                                const categoryDocId = querySnapshot.docs[0].id;

                                // Update the category with the new amount
                                db.collection("categories").doc(categoryDocId).update({
                                    amount: firebase.firestore.FieldValue.increment(amount)
                                })
                                .then(() => {
                                    // After category update, update user balance
                                    db.collection("users").doc(userId).update({
                                        balance: firebase.firestore.FieldValue.increment(-amount)
                                    })
                                    .then(() => {
                                        alert("Category and balance updated successfully!");
                                        document.getElementById("balanceModal").querySelector('.btn-close').click();
                                        location.reload(); // Reload the page to see updated data
                                    })
                                    .catch((error) => {
                                        console.error("Error updating user balance:", error);
                                    });
                                })
                                .catch((error) => {
                                    console.error("Error updating category:", error);
                                });
                            } else {
                                console.error("Category not found.");
                            }
                        })
                        .catch((error) => {
                            console.error("Error fetching category:", error);
                        });
                } else {
                    console.error("Category or amount not properly defined.");
                }
            })
            .catch((error) => {
                console.error("Error fetching user data:", error);
            });
    });
} else {
    console.error("Balance form not found.");
}

                        
                          db.collection("categories")
                      .where("userId", "==", userId)
                      .get()
                      .then((querySnapshot) => {
                        const categoryDropdowBM = document.getElementById("categoryDropdownBM")
                              if (querySnapshot.empty) {
                                  console.log("No categories found for the user.");
                                  categoryDropdown.innerHTML = "No categories found";
                              } else {
                                  querySnapshot.forEach((doc) => {
                                      const category = doc.data();
                                      const options = document.createElement("option");
                                      if (category) {
                                          options.innerHTML = `
                                              ${category.name || 'N/A'}
                                          `;
                                          categoryDropdowBM.appendChild(options);
                                      }
                                  });
                                }
                          })

                          // Balance form 


                                            // Also handle close button specifically in case of a direct click
                                  const closeButton = transactionModal.querySelector('.btn-close');
                                  if (closeButton) {
                                      closeButton.addEventListener('click', function() {
                                          // Reset the form fields
                                      document.getElementById("transactionForm").reset();
                                      
                                      // Reset the modal title to "Add Transaction"
                                      document.getElementById("transactionModalLabel").innerHTML = "Add Transaction";

                                      // Reset the transaction ID to null to indicate a new transaction
                                      currentTransactionId = null;
                                      console.log("Transaction modal reset after closing");
                                      });
                                  } else {
                                  console.error("Transaction modal not found.");
                              }
                                    

                  function handleTransaction(transactionId) {
                      if (currentTransactionId != null) {
                          editTransaction(currentTransactionId);
                      } else {
                          addTransaction();
                      }
                  } 
                  
  
                  function addTransaction() {
                      const date = document.getElementById("transactionDate").value;
                      const description = document.getElementById("transactionDescription").value;
                      const category = document.getElementById("transactionCategory").value;
                      const amount = parseFloat(document.getElementById("transactionAmount").value);
  
                      if (date && description && category && amount && currentTransactionId === null) {
                          db.collection("transactions").add({
                              userId: userId,
                              date: date,
                              description: description,
                              category: category,
                              amount: amount
                          })
                          .then(() => {
                              alert("New transaction added successfully!");
                              document.getElementById("transactionModal").querySelector('.btn-close').click();
                              location.reload(); // Reload page to see updated data
                          })
                          .catch((error) => {
                              console.error("Error adding new transaction:", error);
                          });
                      }
                  }
  
                  function editTransaction(transactionId) {
                    // Fetch the transaction document from Firestore
  firebase.firestore().collection("transactions").doc(transactionId).get()
    .then((doc) => {
      if (doc.exists) {
        const transaction = doc.data();
        
        
        // Populate the modal fields with transaction data
        document.getElementById("transactionDate").value = transaction.date;
        document.getElementById("transactionModalLabel").innerHTML= "Edit Transaction"
        document.getElementById("transactionDescription").value = transaction.description;
        document.getElementById("transactionCategory").value = transaction.category;
        document.getElementById("transactionAmount").value = transaction.amount;

       
  
                                          // Show the transactionModal modal
                                          const transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'), {});
                                          transactionModal.show();
                                          document.getElementById('transactionModal').addEventListener('submit', function(event) {
                                            event.preventDefault();                                  

         // Grab edited data 
                      const date = document.getElementById("transactionDate").value;
                      const description = document.getElementById("transactionDescription").value;
                      const category = document.getElementById("transactionCategory").value;
                      const amount = parseFloat(document.getElementById("transactionAmount").value);

                      if (date && description && category && amount && currentTransactionId != null) {
                          db.collection("transactions").doc(transactionId).update({
                              date: date,
                              description: description,
                              category: category,
                              amount: amount
                          })
                          .then(() => {
                              alert("Transaction successfully edited!");
                              currentTransactionId = null; // Reset the flag
                              document.getElementById("transactionModal").querySelector('.btn-close').click();
                              location.reload(); // Reload page to see updated data
                          })
                          .catch((error) => {
                              console.error("Error updating transaction:", error);
                          });
                      }
                  })}})};
  
                  
  
                  // Category Form Logic
                  const categoryForm = document.getElementById("categoryForm");
                  if (categoryForm) {
                      console.log("category form found:", categoryForm);
                      categoryForm.addEventListener("submit", function (event) {
                          event.preventDefault();
  
                          const category = document.getElementById("categoryName").value;
                          const amount = parseFloat(document.getElementById("categoryAmount").value);
                          const categoryType = document.querySelector('input[name="categoryType"]:checked').value;
                          if (category && amount && categoryType) {
                             
                          }
                      });
                  } else {
                      console.error("category form not found.");
                  }
  
                  // Fetch Transactions
                  db.collection("transactions")
                      .where("userId", "==", userId)
                      .get()
                      .then((querySnapshot) => {
                          const transactionsTableBody = document.getElementById("transactionsTableBody");
                          if (transactionsTableBody) {
                              transactionsTableBody.innerHTML = ""; // Clear previous data to avoid duplicates
  
                              if (querySnapshot.empty) {
                                  console.log("No transactions found for the user.");
                                  transactionsTableBody.innerHTML = "No transactions found";
                              } else {
                                  querySnapshot.forEach((doc) => {
                                      const transaction = doc.data();
                                      const row = document.createElement("tr");
                                      if (transaction) {
                                          row.innerHTML = `
                                              <td>${transaction.date || 'N/A'}</td>
                                              <td>${transaction.description || 'N/A'}</td>
                                              <td>${transaction.category || 'N/A'}</td>
                                              <td>$${transaction.amount || 'N/A'}</td>
                                              <td>
                                                  <button class="transaction-edit" aria-label="Edit transaction" data-transaction-id="${doc.id}">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                              </td>
                                              <td>
                                                  <button class="transaction-delete" aria-label="Delete transaction" data-transaction-id="${doc.id}">
                                                      <i class="fas fa-trash"></i>
                                                  </button>
                                              </td>
                                          `;
                                          transactionsTableBody.appendChild(row);
                                      }
                                  });

                                  //Edit Transaction
                                  document.querySelectorAll('.transaction-edit').forEach(button => {
                            button.addEventListener('click', (event) => {
                              const transactionId = event.currentTarget.getAttribute('data-transaction-id');
                              if (transactionId) {
                                currentTransactionId = transactionId;
                                handleTransaction()
                              } else {
                                console.error('Transaction ID is not set or is empty.');
                              }
                            })});
                                                            //Delete Transaction 
                                                            document.querySelectorAll('.transaction-delete').forEach(button => {
                            button.addEventListener('click', (event) => {
                              const transactionId = event.currentTarget.getAttribute('data-transaction-id');
                              if (transactionId) {
                                const deleteModal = new bootstrap.Modal(document.getElementById("deleteTransactionModal"));
                                
                                
                                // Show the delete modal
                                deleteModal.show();

                                const deleteTranBtn = document.getElementById("confirmDeleteTransaction");
                                deleteTranBtn.onclick =()=>{
                                  deleteTransaction(transactionId);
                                  deleteModal.hide();
                                };
                                const cancelTranBtn = document.getElementById("keepData");
                                cancelTranBtn.onclick=()=>{
                                  deleteModal.hide();
                                };
                              } else {
                                console.error('Transaction ID is not set or is empty.');
                              }
                            });
                          });
                          const deleteTransaction = (transactionId) => {
                            db.collection("transactions").doc(transactionId).delete().then(() => {
                              alert("Transaction successfully deleted !");
                              document.querySelector(`[data-transaction-id="${transactionId}"]`).closest('tr').remove();
                          }).catch((error) => {
                              console.error("Error removing document: ", error);
                          });
                                      }
                              }
                          } else {
                              console.error("Transactions table body not found.");
                          }
                      })
                      .catch((error) => {
                          console.error("Error fetching transactions:", error);
                      });
                      
                      
                                          // Account form logic
                              accountForm.addEventListener("submit", function(event) {
                              event.preventDefault(); // Corrected the preventDefault method

                              const account = document.getElementById("accountName").value;
                              const balance = parseFloat(document.getElementById("accountBalance").value); // Corrected the ID for balance
                              const accountType = document.querySelector('input[name="accountType"]:checked').value;

                              if (account && balance && accountType) {
                                db.collection("accounts").add({
                                  userId: userId,
                                  accountName: account,
                                  balance: balance,
                                  accountType: accountType
                                })
                                .then((docRef) => {
                                  if (docRef.id) {
                                    console.log("Transaction ID:", docRef.id);
                                    // Update user's document with new account info
                                    db.collection("users").doc(userId).update({
                                      accounts: firebase.firestore.FieldValue.arrayUnion(docRef.id),
                                      balance: firebase.firestore.FieldValue.increment(balance)
                                    })
                                    .then(() => {
                                      console.log("Account form submitted");
                                      console.log("Account successfully added, docRef:", docRef);
                                      console.log("Looking for:", docRef.id);
                                      console.log("Looking for:",  db.collection("users").doc(userId));
                                      console.log("Updating user with new account...");

                                      alert("New account added successfully!");
                                      // Close modal and reload page
                                      document.getElementById("accountModal").querySelector('.btn-close').click();
                                      location.reload();
                                    })
                                    .catch((error) => {
                                      console.error("Error updating user document:", error);
                                    });
                                  }
                                })
                                .catch((error) => {
                                  console.error("Error adding new account:", error); // Corrected the error message
                                });
                              }
});


                                            
                  // category Pie Chart Section
                  const ctx = document.getElementById("categoryChart")?.getContext("2d");
  
                  if (ctx) {
                      db.collection("categories").where("userId", "==", userId)
                          .get()
                          .then((querySnapshot) => {
                              const categoryData = [];
                              const categoryLabels = [];
  
                              querySnapshot.forEach((doc) => {
                                  const category = doc.data();
                                  categoryLabels.push(category.category);
                                  categoryData.push(category.amount);
                              });
  
                              new Chart(ctx, {
                                  type: "pie",
                                  data: {
                                      labels: categoryLabels,
                                      datasets: [{
                                          data: categoryData,
                                          backgroundColor: [
                                              "#b91d47",
                                              "#00aba9",
                                              "#2b5797",
                                              "#e8c3b9",
                                              "#1e7145"
                                          ],
                                      }]
                                  },
                                  options: {
                                      responsive: true,
                                      plugins: {
                                          legend: {
                                              position: 'top',
                                          },
                                          title: {
                                              display: true,
                                              text: 'category Overview by Category'
                                          }
                                      }
                                  }
                              });
                          })
                          .catch((error) => {
                              console.error("Error fetching category data:", error);
                          });
                  } else {
                      console.error("category chart context not found.");
                  }
              } else {
                  console.log("No user is signed in, redirecting to login page.");
                  window.location.href = "signin.html";
              }
          });
      });
  </script>
  
</body>

</html>
